# 回收箱功能故障排除指南

## 🎯 当前状态检查

### ✅ 数据库迁移已完成
你已经成功应用了数据库迁移，所有必需的字段都已添加：
- `deleted_at` - 软删除时间戳 ✅
- `is_durationless` - 无时长任务支持 ✅
- `time_limit_hours` - 任务群时间限制 ✅
- 其他相关字段 ✅

### 🔧 如果回收箱仍然不工作

#### 步骤1: 强制刷新应用程序
1. **清除浏览器缓存**：
   - Chrome: Ctrl+Shift+R (强制刷新)
   - 或者 F12 → Network 标签 → 勾选 "Disable cache" → 刷新页面

2. **等待架构缓存更新**：
   - 应用程序有1分钟的架构缓存
   - 等待1-2分钟后重新加载页面

#### 步骤2: 验证软删除功能
在 Supabase Dashboard 的 SQL Editor 中运行 `test-soft-delete.sql`：

```sql
-- 查看你的所有链条
SELECT id, name, type, deleted_at,
       CASE WHEN deleted_at IS NULL THEN 'Active' ELSE 'Deleted' END as status
FROM chains 
WHERE user_id = auth.uid()
ORDER BY created_at DESC;
```

#### 步骤3: 手动测试软删除
如果需要测试，可以手动软删除一个链条：

```sql
-- 替换 'your-chain-id' 为实际的链条ID
UPDATE chains 
SET deleted_at = NOW() 
WHERE id = 'your-chain-id' AND user_id = auth.uid();
```

然后刷新应用程序，检查：
1. 该链条是否从主界面消失
2. 回收箱中是否显示该链条
3. 回收箱按钮是否显示数量标记

#### 步骤4: 检查浏览器控制台
打开浏览器开发者工具 (F12)，查看控制台是否有错误信息：

**期望看到的日志**：
```
Schema cache cleared - will re-verify database schema
数据库架构检查发现缺失列: []  // 空数组表示没有缺失字段
回退保存成功，使用完整字段集  // 或者这个消息
```

**如果仍然看到错误**：
```
数据库架构检查发现缺失列: ['deleted_at', ...]
```
说明架构缓存还没有更新，等待几分钟后重试。

## 🚀 完整功能测试流程

### 1. 创建测试链条
1. 在应用中创建一个新的链条
2. 确认它出现在主界面

### 2. 测试软删除
1. 删除刚创建的链条
2. 确认它从主界面消失
3. 检查回收箱按钮是否显示数量 (1)

### 3. 测试恢复功能
1. 打开回收箱
2. 找到刚删除的链条
3. 点击"恢复"按钮
4. 确认链条重新出现在主界面

### 4. 测试永久删除
1. 再次删除链条
2. 在回收箱中点击"永久删除"
3. 确认链条彻底消失

## 🔍 常见问题解答

### Q: 为什么回收箱显示为空？
A: 可能的原因：
1. 架构缓存还没有更新 - 等待1-2分钟
2. 之前删除的链条是永久删除的 - 创建新链条测试
3. 浏览器缓存问题 - 强制刷新页面

### Q: 删除链条时仍然是永久删除？
A: 检查浏览器控制台，如果看到：
```
数据库不支持软删除，执行永久删除
```
说明架构缓存还没有更新，等待几分钟后重试。

### Q: 如何确认数据库迁移成功？
A: 在 Supabase Dashboard 中运行：
```sql
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'chains' AND column_name = 'deleted_at';
```
应该返回 `deleted_at` 行。

## 📞 最终解决方案

如果以上步骤都不能解决问题，尝试：

1. **完全重启浏览器**
2. **等待5-10分钟**让所有缓存过期
3. **重新访问应用程序**
4. **创建新链条并测试删除功能**

数据库迁移已经成功，只是需要时间让应用程序识别新的架构！🎉